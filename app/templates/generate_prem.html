
{% extends 'base_authenticated.html' %}

{% block title %}Generador Premium de Comunicacions{% endblock %}

{% block content %}
<!-- Page header -->
<div class="page-header">
    <h1 class="page-title">Generador Premium de Comunicacions</h1>
    <p class="page-subtitle">Genera comunicacions professionals amb segmentaci√≥ avan√ßada de clients i context personalitzat</p>
</div>

<!-- Quick Actions -->
<div class="block">
    <div class="block-title">
        <div class="block-number">‚ö°</div>
        <h2>Accions R√†pides</h2>
    </div>
    <div class="block-content">
        <div class="quick-actions-grid">
            <a href="/context/" class="quick-action-card">
                <div class="quick-action-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 12l2 2 4-4"/>
                        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3 4-3 9-3 9 1.34 9 3z"/>
                        <path d="M21 5c0 1.66-4 3-9 3S3 6.66 3 5s4-3 9-3 9 1.34 9 3z"/>
                        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
                    </svg>
                </div>
                <h3>Afegir Context</h3>
                <p>Personalitza el context empresarial per comunicacions m√©s precises</p>
            </a>
            
            <a href="/clusters/" class="quick-action-card">
                <div class="quick-action-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="9" cy="12" r="1"/>
                        <circle cx="9" cy="5" r="1"/>
                        <circle cx="9" cy="19" r="1"/>
                        <circle cx="15" cy="12" r="1"/>
                        <circle cx="15" cy="5" r="1"/>
                        <circle cx="15" cy="19" r="1"/>
                    </svg>
                </div>
                <h3>Generar Segments</h3>
                <p>Crea segments de clients amb IA per comunicacions dirigides</p>
            </a>
        </div>
    </div>
</div>

<!-- Generated Communications -->
<div class="block">
    <div class="block-title">
        <div class="block-number success">1</div>
        <h2>Comunicacions Generades</h2>
    </div>
    <div class="block-content">
        {% if generated_metadata %}
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Comunicaci√≥</th>
                            <th class="th-hidden-mobile">Prompt</th>
                            <th>Plantilla</th>
                            <th class="th-hidden-mobile">Segmentaci√≥</th>
                            <th class="th-hidden-mobile">Data</th>
                            <th>Accions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for meta in generated_metadata %}
                        <tr>
                            <td>
                                <div class="table-cell-main">
                                    <div class="cell-title">{{ meta.name }}</div>
                                    <div class="cell-subtitle visible-mobile">
                                        {{ meta.created_at|date:"d/m/Y H:i" }}
                                    </div>
                                </div>
                            </td>
                            <td class="td-hidden-mobile">
                                <div class="table-cell-text" title="{{ meta.prompt }}">
                                    {{ meta.prompt|truncatechars:80 }}
                                </div>
                            </td>
                            <td>
                                <span class="table-badge table-badge-secondary">
                                    {{ meta.template|cut:".html"|title }}
                                </span>
                            </td>
                            <td class="td-hidden-mobile">
                                <div class="table-cell-group">
                                    {% if meta.dataset %}
                                        <span class="table-badge table-badge-info">{{ meta.dataset|title }}</span>
                                        {% if meta.cluster %}
                                            <span class="table-badge table-badge-primary">{{ meta.cluster }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="table-text-muted">General</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="td-hidden-mobile">
                                <time class="table-cell-date">
                                    {{ meta.created_at|date:"d/m/Y H:i" }}
                                </time>
                            </td>
                            <td>
                                <div class="table-actions">
                                    <a href="/generated/{{ meta.filename }}" target="_blank" 
                                       class="table-btn table-btn-view" title="Veure comunicaci√≥">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                    </a>
                                    <form method="post" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="delete">
                                        <input type="hidden" name="filename" value="{{ meta.filename }}">
                                        <button type="submit" class="table-btn table-btn-delete" 
                                                title="Eliminar comunicaci√≥" 
                                                onclick="return confirm('Est√†s segur que vols eliminar aquesta comunicaci√≥?')">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M3 6h18"/>
                                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                                <line x1="10" y1="11" x2="10" y2="17"/>
                                                <line x1="14" y1="11" x2="14" y2="17"/>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="var(--gray-400)">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                </div>
                <h3 class="empty-state-title">Encara no tens comunicacions generades</h3>
                <p class="empty-state-text">Utilitza el formulari de sota per crear la teva primera comunicaci√≥ amb IA</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Generator Form -->
<div class="block">
    <div class="block-title">
        <div class="block-number">2</div>
        <h2>Nova Comunicaci√≥</h2>
    </div>
    <div class="block-content">
        <form method="POST" id="generate-form" class="form-flow">
            {% csrf_token %}
            
            <!-- Step 1: Basic Information -->
            <div class="form-step">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-info">
                        <h3>Informaci√≥ b√†sica</h3>
                        <p>Comen√ßarem amb el nom i tipus de comunicaci√≥</p>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="name" class="form-label form-label-with-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="form-label-icon">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                                <polyline points="14,2 14,8 20,8"/>
                            </svg>
                            Nom de la comunicaci√≥
                        </label>
                        <input type="text" id="name" name="name" class="form-input" required 
                               placeholder="Ex: Oferta especial Black Friday, Newsletter setmanal...">
                        <div class="form-help">Aquest nom t'ajudar√† a identificar la comunicaci√≥ m√©s endavant</div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Template Selection -->
            <div class="form-step">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-info">
                        <h3>Selecciona una plantilla</h3>
                        <p>Tria el tipus de comunicaci√≥ que vols crear</p>
                    </div>
                </div>
                
                <div class="template-selector">
                    <input type="hidden" id="template" name="template" required>
                    <div class="template-grid">
                        <div class="template-card" data-template="sale.html">
                            <div class="template-icon">üí∞</div>
                            <h3>Vendes</h3>
                            <p>Promocions i ofertes comercials</p>
                        </div>
                        <div class="template-card" data-template="tips.html">
                            <div class="template-icon">üí°</div>
                            <h3>Consells</h3>
                            <p>Consells √∫tils i pr√†ctics</p>
                        </div>
                        <div class="template-card" data-template="newsletter.html">
                            <div class="template-icon">üìß</div>
                            <h3>Newsletter</h3>
                            <p>Butllet√≠ informatiu</p>
                        </div>
                        <div class="template-card" data-template="welcome.html">
                            <div class="template-icon">üëã</div>
                            <h3>Benvinguda</h3>
                            <p>Missatges de benvinguda</p>
                        </div>
                        <div class="template-card" data-template="event.html">
                            <div class="template-icon">üéâ</div>
                            <h3>Esdeveniment</h3>
                            <p>Invitacions i esdeveniments</p>
                        </div>
                        <div class="template-card" data-template="survey.html">
                            <div class="template-icon">üìä</div>
                            <h3>Enquesta</h3>
                            <p>Recollida d'opinions</p>
                        </div>
                        <div class="template-card" data-template="thank_you.html">
                            <div class="template-icon">üôè</div>
                            <h3>Agra√Øment</h3>
                            <p>Missatges de gratitud</p>
                        </div>
                        <div class="template-card" data-template="reminder.html">
                            <div class="template-icon">‚è∞</div>
                            <h3>Recordatori</h3>
                            <p>Recordatoris i avisos</p>
                        </div>
                        <div class="template-card" data-template="announcement.html">
                            <div class="template-icon">üì¢</div>
                            <h3>Anunci</h3>
                            <p>Comunicats oficials</p>
                        </div>
                        <div class="template-card" data-template="seasonal.html">
                            <div class="template-icon">üéÑ</div>
                            <h3>Estacional</h3>
                            <p>Campanyes tem√†tiques</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Content Description -->
            <div class="form-step">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-info">
                        <h3>Descriu el contingut</h3>
                        <p>Explica qu√® vols comunicar i com ho vols enfocar</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="prompt" class="form-label form-label-with-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="form-label-icon">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                        </svg>
                        Contingut a generar
                    </label>
                    <textarea id="prompt" name="prompt" class="form-textarea" rows="5" required 
                              placeholder="Descriu detalls espec√≠fics del que vols comunicar:&#10;&#10;‚Ä¢ Quin √©s l'objectiu principal?&#10;‚Ä¢ A qui va dirigit?&#10;‚Ä¢ Quin to vols utilitzar?&#10;‚Ä¢ Quins detalls espec√≠fics cal incloure?&#10;&#10;Exemple: 'Vull promocionar una oferta de descompte del 20% en tots els productes d'hivern. Va dirigit a clients habituals amb un to amigable i urgent. Cal destacar que l'oferta √©s limitada fins diumenge.'"></textarea>
                    <div class="form-help">Sigues espec√≠fic per obtenir millors resultats. Inclou detalls sobre el to, l'audi√®ncia i els punts clau a destacar.</div>
                </div>
            </div>

            <!-- Step 4: Audience Targeting -->
            <div class="form-step">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <div class="step-info">
                        <h3>Segmentaci√≥ d'audi√®ncia <span class="premium-badge">Premium</span></h3>
                        <p>Personalitza la comunicaci√≥ per un segment espec√≠fic de clients</p>
                    </div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="dataset" class="form-label">Dataset de clients</label>
                        <select name="dataset" id="dataset" class="form-select">
                            <option value="">-- Sense segmentaci√≥ espec√≠fica --</option>
                            {% for dataset in available_datasets %}
                                <option value="{{ dataset.name }}">{{ dataset.name|title }} ({{ dataset.num_clusters }} segments)</option>
                            {% endfor %}
                        </select>
                        <div class="form-help">Selecciona un dataset per dirigir la comunicaci√≥ a segments espec√≠fics</div>
                    </div>

                    <div class="form-group">
                        <label for="cluster" class="form-label">Segment espec√≠fic</label>
                        <select name="cluster" id="cluster" class="form-select" disabled>
                            <option value="">-- Primer selecciona un dataset --</option>
                        </select>
                        <div class="form-help">Escull un segment concret o deixa-ho buit per a tots els segments</div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="block-actions">
        <button type="reset" form="generate-form" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 6h18l-1.5 12a2 2 0 0 1-2 1.84H6.5a2 2 0 0 1-2-1.84L3 6ZM8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
            Netejar formulari
        </button>
        <button type="submit" form="generate-form" class="btn btn-primary btn-lg">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="10"/>
                <path d="M8 12l2 2 4-4"/>
            </svg>
            Generar Comunicaci√≥
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const datasetSelect = document.getElementById('dataset');
    const clusterSelect = document.getElementById('cluster');
    const templateCards = document.querySelectorAll('.template-card');
    const templateInput = document.getElementById('template');

    // Template selector functionality
    templateCards.forEach(card => {
        card.addEventListener('click', function() {
            // Remove selected class from all cards
            templateCards.forEach(c => c.classList.remove('selected'));
            
            // Add selected class to clicked card
            this.classList.add('selected');
            
            // Set the hidden input value
            templateInput.value = this.dataset.template;
        });
    });

    // Dades dels clusters per dataset
    const datasetsData = {
        {% for dataset in available_datasets %}
        '{{ dataset.name }}': {
            {% if dataset.descriptions %}
                {% for cluster_key, cluster_desc in dataset.descriptions.items %}
                    '{{ cluster_key }}': '{{ cluster_desc.name|default:"Cluster"|escapejs }}',
                {% endfor %}
            {% endif %}
        },
        {% endfor %}
    };

    datasetSelect.addEventListener('change', function() {
        const selectedDataset = this.value;
        clusterSelect.innerHTML = '';

        if (selectedDataset === '') {
            clusterSelect.disabled = true;
            clusterSelect.innerHTML = '<option value="">-- Selecciona primer un dataset --</option>';
            return;
        }

        clusterSelect.disabled = false;
        clusterSelect.innerHTML = '<option value="">-- Tots els clusters --</option>';

        const clusters = datasetsData[selectedDataset] || {};
        for (const [clusterId, clusterName] of Object.entries(clusters)) {
            const option = document.createElement('option');
            option.value = clusterId;
            option.textContent = clusterName;
            clusterSelect.appendChild(option);
        }
    });
});
</script>

{% endblock %}

{% block extra_css %}
<style>
/* Quick Actions Grid */
.quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-6);
    margin-top: var(--space-4);
}

.quick-action-card {
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    text-decoration: none;
    color: inherit;
    transition: all var(--transition-normal);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
}

.quick-action-card:hover {
    border-color: var(--primary-400);
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
    text-decoration: none;
    color: inherit;
}

.quick-action-icon {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    border-radius: var(--radius-xl);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: var(--space-4);
    color: white;
}

.quick-action-card h3 {
    font-size: var(--font-size-lg);
    font-weight: 600;
    margin-bottom: var(--space-2);
    color: var(--gray-900);
}

.quick-action-card p {
    font-size: var(--font-size-sm);
    color: var(--gray-600);
    margin: 0;
    line-height: 1.5;
}

/* Premium badge */
.premium-badge {
    background: linear-gradient(135deg, var(--warning-500), var(--warning-600));
    color: white;
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--font-size-xs);
    font-weight: 600;
    margin-left: var(--space-2);
}

@media (max-width: 768px) {
    .quick-actions-grid {
        grid-template-columns: 1fr;
        gap: var(--space-4);
    }
    
    .quick-action-card {
        padding: var(--space-4);
    }
    
    .quick-action-icon {
        width: 48px;
        height: 48px;
    }
}
</style>
{% endblock %}
