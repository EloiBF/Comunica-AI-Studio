{% extends 'base_authenticated.html' %}

{% block title %}Generador de Comunicacions{% endblock %}

{% block content %}
<div class="generate-page">
    <!-- Page header -->
    <header class="page-header mb-8">
        <h1 class="page-title">
            Generador de Comunicacions
        </h1>
        <p class="page-subtitle">
            Genera comunicacions professionals de manera ràpida i senzilla, personalitzant-les a partir de prompts i plantilles
        </p>
    </header>

    <!-- Form Section -->
    <section class="form-section mb-12" aria-labelledby="form-title">
        <div class="card">
            <div class="card-header">
                <h2 id="form-title" class="card-title">
                    Nova Comunicació
                </h2>
            </div>
            <div class="card-content">
                <form method="POST" class="generate-form">
                    {% csrf_token %}

                    <div class="form-group">
                        <label for="name" class="form-label form-label-with-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="form-label-icon">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                                <polyline points="14,2 14,8 20,8"/>
                            </svg>
                            Nom de la comunicació
                        </label>
                        <input type="text" id="name" name="name" class="form-input" required 
                               placeholder="Introdueix un nom descriptiu per la teva comunicació">
                    </div>

                    <div class="form-group">
                        <label for="prompt" class="form-label form-label-with-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="form-label-icon">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            Prompt
                        </label>
                        <textarea id="prompt" name="prompt" class="form-textarea" required 
                                  placeholder="Descriu el tipus de comunicació que vols generar. Sigues específic per obtenir millors resultats."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="template" class="form-label form-label-with-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" class="form-label-icon">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <line x1="9" y1="9" x2="15" y2="9"/>
                                <line x1="9" y1="13" x2="15" y2="13"/>
                                <line x1="9" y1="17" x2="13" y2="17"/>
                            </svg>
                            Plantilla
                        </label>
                        <select id="template" name="template" class="form-select" required>
                            <option value="">Selecciona una plantilla</option>
                            <option value="sale.html">Plantilla de Vendes</option>
                            <option value="tips.html">Plantilla de Consells</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="dataset" class="form-label">Dataset (opcional)</label>
                        <select name="dataset" id="dataset" class="form-select">
                            <option value="">-- Sense segmentació --</option>
                            {% for dataset in available_datasets %}
                                <option value="{{ dataset.name }}">{{ dataset.name|title }} ({{ dataset.num_clusters }} clusters)</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="cluster" class="form-label">Cluster (opcional)</label>
                        <select name="cluster" id="cluster" class="form-select" disabled>
                            <option value="">-- Selecciona primer un dataset --</option>
                        </select>
                    </div>

                    <div class="form-actions form-actions-end">
                        <button type="reset" class="btn btn-secondary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 6h18l-1.5 12a2 2 0 0 1-2 1.84H6.5a2 2 0 0 1-2-1.84L3 6ZM8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                <line x1="10" y1="11" x2="10" y2="17"/>
                                <line x1="14" y1="11" x2="14" y2="17"/>
                            </svg>
                            Netejar
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 12l2 2 4-4"/>
                            </svg>
                            Generar Comunicació
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Communications Table -->
    <section class="communications-section" aria-labelledby="communications-title">
        <div class="card">
            <div class="card-header">
                <h2 id="communications-title" class="card-title">
                    Comunicacions Generades
                </h2>
            </div>
            <div class="card-content">
                {% if generated_metadata %}
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Prompt</th>
                                    <th>Plantilla</th>
                                    <th>Dataset</th>
                                    <th>Cluster</th>
                                    <th>Data de Creació</th>
                                    <th>Accions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for meta in generated_metadata %}
                                <tr>
                                    <td>
                                        <div class="table-cell-primary">
                                            {{ meta.name }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="table-cell-prompt" title="{{ meta.prompt }}">
                                            {{ meta.prompt }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge badge-secondary">
                                            {{ meta.template }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if meta.dataset %}
                                            <span class="badge badge-secondary">{{ meta.dataset|title }}</span>
                                        {% else %}
                                            <span class="text-gray-500">Sense dataset</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if meta.cluster %}
                                            <span class="badge badge-primary">{{ meta.cluster }}</span>
                                        {% else %}
                                            <span class="text-gray-500">Tots</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <time class="table-cell-date">
                                            {{ meta.created_at|date:"d/m/Y H:i" }}
                                        </time>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="/generated/{{ meta.filename }}" target="_blank" class="btn-icon btn-icon-primary" title="Veure comunicació">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                                    <circle cx="12" cy="12" r="3"/>
                                                </svg>
                                            </a>
                                            <form method="post" style="display: inline;">
                                                {% csrf_token %}
                                                <input type="hidden" name="action" value="delete">
                                                <input type="hidden" name="filename" value="{{ meta.filename }}">
                                                <button type="submit" class="btn-icon btn-icon-danger" title="Eliminar comunicació" onclick="return confirm('Estàs segur que vols eliminar aquesta comunicació?')">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                                        <path d="M3 6h18"/>
                                                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                                        <line x1="10" y1="11" x2="10" y2="17"/>
                                                        <line x1="14" y1="11" x2="14" y2="17"/>
                                                    </svg>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="var(--gray-400)">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                            </svg>
                        </div>
                        <h3 class="empty-state-title">
                            Encara no tens comunicacions generades
                        </h3>
                        <p class="empty-state-text">
                            Utilitza el formulari de dalt per crear la teva primera comunicació amb IA
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const datasetSelect = document.getElementById('dataset');
    const clusterSelect = document.getElementById('cluster');

    // Dades dels clusters per dataset
    const datasetsData = {
        {% for dataset in available_datasets %}
        '{{ dataset.name }}': {
            {% if dataset.descriptions %}
                {% for cluster_key, cluster_desc in dataset.descriptions.items %}
                    '{{ cluster_key }}': '{{ cluster_desc.name|default:"Cluster"|escapejs }}',
                {% endfor %}
            {% endif %}
        },
        {% endfor %}
    };

    datasetSelect.addEventListener('change', function() {
        const selectedDataset = this.value;
        clusterSelect.innerHTML = '';

        if (selectedDataset === '') {
            clusterSelect.disabled = true;
            clusterSelect.innerHTML = '<option value="">-- Selecciona primer un dataset --</option>';
            return;
        }

        clusterSelect.disabled = false;
        clusterSelect.innerHTML = '<option value="">-- Tots els clusters --</option>';

        const clusters = datasetsData[selectedDataset] || {};
        for (const [clusterId, clusterName] of Object.entries(clusters)) {
            const option = document.createElement('option');
            option.value = clusterId;
            option.textContent = clusterName;
            clusterSelect.appendChild(option);
        }
    });
});
</script>

{% endblock %}