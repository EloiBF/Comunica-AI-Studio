{% extends 'base_authenticated.html' %}

{% block title %}Generador de Comunicacions{% endblock %}

{% block content %}
<!-- Page header -->
<div class="page-header">
    <h1 class="page-title">Generador de Comunicacions</h1>
    <p class="page-subtitle">Genera comunicacions professionals amb IA</p>
</div>

<!-- Generator Form -->
<div class="block">
    <div class="block-title">
        <div class="block-number">1</div>
        <h2>Nova Comunicació</h2>
    </div>
    <div class="block-content">
        <form method="POST" id="generate-form" class="form-visual">
            {% csrf_token %}
            
            <!-- Name field -->
            <div class="form-section">
                <div class="form-group">
                    <label for="name" class="form-label">Nom de la comunicació</label>
                    <input type="text" id="name" name="name" class="form-input" required 
                           placeholder="Ex: Oferta Black Friday, Newsletter desembre...">
                </div>
            </div>

            <!-- Template Selection -->
            <div class="form-section">
                <label class="form-label">Selecciona el tipus de comunicació</label>
                <div class="template-selector">
                    <input type="hidden" id="template" name="template" required>
                    <div class="template-grid">
                        {% for template in templates %}
                            <div class="template-card" data-template="{{ template.0 }}">
                                <div class="template-icon">{{ template.1 }}</div>
                                <h3>{{ template.2 }}</h3>
                                <p>{{ template.3 }}</p>
                                <div class="template-actions">
                                    <a href="/plantilla_preview/{{ template.0 }}" target="_blank" class="btn btn-sm btn-secondary">
                                        Previsualitza
                                    </a>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Content Description -->
            <div class="form-section">
                <div class="form-group">
                    <label for="prompt" class="form-label">Què vols comunicar?</label>
                    <textarea id="prompt" name="prompt" class="form-textarea" rows="4" required 
                              placeholder="Descriu breument què vols comunicar, a qui va dirigit i el to que vols utilitzar.&#10;&#10;Exemple: Promocionar descompte 20% en productes d'hivern per clients habituals, to amigable i urgent, oferta fins diumenge."></textarea>
                </div>
            </div>

            <!-- Template Preview Section -->
            <div id="template-preview" class="form-section" style="display:none;">
                <h3>Previsualització de la plantilla seleccionada</h3>
                <div id="preview-container" class="form-textarea">
                    <!-- La previsualització es carregarà aquí dinàmicament -->
                </div>
            </div>

            <div class="form-section premium-section-disabled">
                <div class="premium-header">
                    <h3 class="form-section-title">
                        Segmentació d'audiència 
                        <span class="premium-badge">Premium</span>
                    </h3>
                    <p class="form-section-subtitle">Personalitza la comunicació per segments específics de clients</p>
                </div>
                <div class="form-grid disabled">
                    <div class="form-group">
                        <label for="dataset" class="form-label">Dataset de clients</label>
                        <select name="dataset" id="dataset" class="form-select" disabled>
                            <option value="">Actualitza a Premium per accedir</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="cluster" class="form-label">Segment específic</label>
                        <select name="cluster" id="cluster" class="form-select" disabled>
                            <option value="">Actualitza a Premium per accedir</option>
                        </select>
                    </div>
                </div>
                <div class="upgrade-prompt">
                    <div class="upgrade-icon">⭐</div>
                    <div class="upgrade-text">
                        <strong>Actualitza a Premium</strong> per accedir a la segmentació avançada de clients i personalització de missatges
                    </div>
                    <a href="#" class="btn btn-warning btn-sm">Actualitzar</a>
                </div>
            </div>
        </form>
    </div>
    
    <div class="block-actions">
        <button type="reset" form="generate-form" class="btn btn-secondary">
            Netejar
        </button>
        <button type="submit" form="generate-form" class="btn btn-primary btn-lg">
            Generar Comunicació
        </button>
    </div>
</div>

<!-- Generated Communications -->
<div class="block">
    <div class="block-title">
        <div class="block-number success">2</div>
        <h2>Comunicacions Generades</h2>
    </div>
    <div class="block-content">
        {% if generated_metadata %}
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Comunicació</th>
                            <th class="th-hidden-mobile">Prompt</th>
                            <th>Plantilla</th>
                            <th class="th-hidden-mobile">Data</th>
                            <th>Accions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for meta in generated_metadata %}
                        <tr>
                            <td>
                                <div class="table-cell-main">
                                    <div class="cell-title">{{ meta.name }}</div>
                                    <div class="cell-subtitle visible-mobile">
                                        {{ meta.created_at|date:"d/m/Y H:i" }}
                                    </div>
                                </div>
                            </td>
                            <td class="td-hidden-mobile">
                                <div class="table-cell-text" title="{{ meta.prompt }}">
                                    {{ meta.prompt|truncatechars:80 }}
                                </div>
                            </td>
                            <td>
                                <span class="table-badge table-badge-secondary">
                                    {{ meta.template|cut:".html"|title }}
                                </span>
                            </td>
                            <td class="td-hidden-mobile">
                                <time class="table-cell-date">
                                    {{ meta.created_at|date:"d/m/Y H:i" }}
                                </time>
                            </td>
                            <td>
                                <div class="table-actions">
                                    <a href="/generated/{{ meta.filename }}" target="_blank" 
                                       class="table-btn table-btn-view" title="Veure comunicació">
                                        Veure
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <h3 class="empty-state-title">Encara no tens comunicacions generades</h3>
                <p class="empty-state-text">Utilitza el formulari de dalt per crear la teva primera comunicació amb IA</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const templateCards = document.querySelectorAll('.template-card');
    const previewButtons = document.querySelectorAll('.preview-button');
    const templateInput = document.getElementById('template');
    const previewContainer = document.getElementById('preview-container');
    const templatePreview = document.getElementById('template-preview');

    // Quan es fa clic en una targeta, selecciona la plantilla però no mostra la previsualització
    templateCards.forEach(card => {
        card.addEventListener('click', function(e) {
            // Evita conflicte amb el botó de previsualització
            if (e.target.classList.contains('preview-button')) return;

            templateCards.forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            templateInput.value = this.dataset.template;
        });
    });

    // Botó de previsualització
    previewButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation(); // Evita que s'activi el clic del pare

            const templateName = this.dataset.template;
            templatePreview.style.display = 'block';
            previewContainer.innerHTML = `
                <iframe src="/plantilla_preview/${templateName}/" width="100%" height="400px" frameborder="0"></iframe>
            `;
        });
    });
});
</script>


{% endblock %}